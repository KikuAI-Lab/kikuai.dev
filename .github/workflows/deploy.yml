name: Deploy to Production (Legacy - VM)

# ⚠️ ВНИМАНИЕ: Сайт теперь деплоится через Cloudflare Pages автоматически!
# Этот workflow отключен (только workflow_dispatch для ручного запуска)
# Если нужен деплой на VM - используй workflow_dispatch

on:
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check YAML
        run: |
          # Skip lint if directories don't exist
          if [ -d "kikuai-platform" ]; then
            yamllint kikuai-platform/compose.yml || true
          fi
          if [ -d "kikuai-infra/ansible" ]; then
            yamllint kikuai-infra/ansible/*.yml || true
          fi

  deploy:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check if kikuai-platform exists
        id: check_platform
        run: |
          if [ ! -d "kikuai-platform" ]; then
            echo "❌ Directory kikuai-platform not found"
            echo "ℹ️  Site is now deployed via Cloudflare Pages automatically"
            echo "ℹ️  This workflow is for legacy VM deployment only"
            exit 1
          fi
          echo "✅ kikuai-platform directory found"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          scp -i ~/.ssh/deploy_key -r kikuai-platform/* $SSH_USER@$SSH_HOST:~/kikuai-platform/
          ssh -i ~/.ssh/deploy_key $SSH_USER@$SSH_HOST << EOF
            cd ~/kikuai-platform
            # Preserve existing .env if it exists, only update token if provided
            if [ -f .env ]; then
              # Backup existing .env
              cp .env .env.backup.$(date +%s)
              # Update token only if CLOUDFLARE_API_TOKEN is provided and not empty
              if [ -n "\$CLOUDFLARE_API_TOKEN" ]; then
                if grep -q "CLOUDFLARE_API_TOKEN=" .env; then
                  sed -i "s/^CLOUDFLARE_API_TOKEN=.*/CLOUDFLARE_API_TOKEN=\$CLOUDFLARE_API_TOKEN/" .env
                else
                  echo "CLOUDFLARE_API_TOKEN=\$CLOUDFLARE_API_TOKEN" >> .env
                fi
              fi
            else
              # Create .env only if token is provided
              if [ -n "\$CLOUDFLARE_API_TOKEN" ]; then
                echo "CLOUDFLARE_API_TOKEN=\$CLOUDFLARE_API_TOKEN" > .env
                chmod 600 .env
              fi
            fi
            # Ensure token is set (run ensure-env.sh if available)
            if [ -f ~/scripts/ensure-env.sh ]; then
              ~/scripts/ensure-env.sh
            fi
            docker compose pull
            docker compose up -d
            docker compose ps
          EOF

      - name: Notify Telegram
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ job.status }}"
          MESSAGE="Deploy $STATUS: ${{ github.ref }} (${{ github.sha }})"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}"

