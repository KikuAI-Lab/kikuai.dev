// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  name          String?
  avatarUrl     String?
  supabaseId    String    @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  accounts      Account[]
  subscriptions Subscription[]
  apiKeys       ApiKey[]
  usageEvents   UsageEvent[]
  invoices      Invoice[]
  auditLogs     AuditLog[]
  
  @@map("users")
}

model Account {
  id          String   @id @default(uuid())
  userId      String
  provider    String   // 'google', 'email', etc.
  providerId  String   // external provider ID
  accessToken String?  @db.Text
  refreshToken String? @db.Text
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerId])
  @@map("accounts")
}

model Product {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  description String?  @db.Text
  status      String   @default("active") // active, archived
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  plans       Plan[]
  
  @@map("products")
}

model Plan {
  id          String   @id @default(uuid())
  productId   String
  name        String
  description String?  @db.Text
  paddlePriceId String @unique // Paddle Price ID
  price       Decimal  @db.Decimal(10, 2)
  currency    String   @default("USD")
  interval    String   // month, year
  limits      Json     // { requests: 10000, rate: 100 }
  features    Json?    // { feature1: true, feature2: false }
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]
  
  @@map("plans")
}

model Subscription {
  id              String   @id @default(uuid())
  userId          String
  planId          String
  paddleSubscriptionId String? @unique
  paddleCustomerId String?
  status          String   // active, canceled, past_due, trialing
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd Boolean @default(false)
  canceledAt       DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan            Plan     @relation(fields: [planId], references: [id])
  invoices        Invoice[]
  
  @@map("subscriptions")
}

model ApiKey {
  id          String   @id @default(uuid())
  userId      String
  name        String
  prefix      String   // kiku_
  keyHash     String   // hashed secret
  keyTail     String   // last 4 chars for display
  lastUsedAt  DateTime?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  usageEvents UsageEvent[]
  
  @@index([userId])
  @@index([prefix])
  @@map("api_keys")
}

model UsageEvent {
  id          String   @id @default(uuid())
  apiKeyId    String
  userId      String
  productSlug String
  endpoint    String
  method      String
  statusCode  Int
  responseTime Int?    // ms
  createdAt   DateTime @default(now())
  
  apiKey      ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
  @@index([apiKeyId, createdAt])
  @@map("usage_events")
}

model UsageCounterDay {
  id          String   @id @default(uuid())
  userId      String
  apiKeyId    String
  productSlug String
  date        DateTime @db.Date
  requests    Int      @default(0)
  errors      Int      @default(0)
  totalResponseTime Int @default(0) // sum in ms
  
  @@unique([userId, apiKeyId, productSlug, date])
  @@index([userId, date])
  @@map("usage_counters_day")
}

model Invoice {
  id                String   @id @default(uuid())
  userId            String
  subscriptionId    String?
  paddleInvoiceId   String   @unique
  paddleTransactionId String?
  amount            Decimal  @db.Decimal(10, 2)
  currency          String   @default("USD")
  status            String   // paid, pending, failed
  paidAt            DateTime?
  invoiceUrl        String?  @db.Text
  receiptUrl        String?  @db.Text
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription      Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  
  @@map("invoices")
}

model WebhookLog {
  id          String   @id @default(uuid())
  provider    String   // paddle
  eventType   String
  payload     Json     @db.JsonB
  signature   String?
  isValid     Boolean
  processed   Boolean  @default(false)
  error       String?  @db.Text
  createdAt   DateTime @default(now())
  
  @@index([provider, eventType])
  @@index([processed])
  @@map("webhook_logs")
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String
  action      String   // create_key, delete_key, update_subscription, etc.
  resourceType String? // api_key, subscription, etc.
  resourceId  String?
  metadata    Json?    @db.JsonB
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
  @@index([action])
  @@map("audit_logs")
}
