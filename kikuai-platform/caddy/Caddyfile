{
  email admin@kikuai.dev
}

kikuai.dev {
  tls {
    dns cloudflare {
      api_token {env.CLOUDFLARE_API_TOKEN}
    }
  }

  root * /www
  file_server

  @health path /healthz
  respond @health 200

  # Maintenance mode: check for flag file (exclude healthz)
  @maintenance {
    file /www/maintenance/.enabled
    not path /healthz
  }
  handle @maintenance {
    rewrite * /maintenance/index.html
    file_server
    header Cache-Control "no-cache, no-store, must-revalidate"
    respond 503
  }

  # 404 handling: try_files will fall back to 404.html if file not found
  try_files {path} {path}/ /404.html

  encode zstd gzip

  header {
    -Server
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Frame-Options "DENY"
    Referrer-Policy "same-origin"
    Permissions-Policy "geolocation=(), microphone=(), camera=()"
    Content-Security-Policy "default-src 'self'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-ancestors 'none';"
  }

  @static {
    path *.css *.js *.jpg *.jpeg *.png *.gif *.svg *.ico *.woff *.woff2 *.ttf *.eot *.webp
  }
  header @static {
    Cache-Control "public, max-age=31536000, immutable"
  }

  @html {
    path *.html
  }
  header @html {
    Cache-Control "public, max-age=3600, must-revalidate"
  }
}

*.kikuai.dev {
  tls {
    dns cloudflare {
      api_token {env.CLOUDFLARE_API_TOKEN}
    }
  }

  @health path /healthz
  respond @health 200

  # Default landing response (until services are attached)
  respond "KikuAI Gateway" 200
}

status.kikuai.dev {
  tls {
    dns cloudflare {
      api_token {env.CLOUDFLARE_API_TOKEN}
    }
  }
  reverse_proxy uptime-kuma:3001
}

tas.kikuai.dev {
  tls {
    dns cloudflare {
      api_token {env.CLOUDFLARE_API_TOKEN}
    }
  }
  @health path /healthz
  respond @health 200
  respond "TAS API (placeholder)" 200
}

patas.kikuai.dev {
  tls {
    dns cloudflare {
      api_token {env.CLOUDFLARE_API_TOKEN}
    }
  }
  @health path /healthz
  respond @health 200
  respond "PATAS API (placeholder)" 200
}

