---
- name: Configure KikuAI prod host
  hosts: prod
  become: true
  vars:
    docker_users:
      - kiku
  roles: []
  tasks:
    - name: Ensure base packages present
      apt:
        name:
          - curl
          - ca-certificates
        state: present
        update_cache: true

    - name: Check if Docker is installed
      command: which docker
      register: docker_check
      changed_when: false
      failed_when: false

    - name: Install Docker (if not installed)
      block:
        - name: Install Docker GPG key
          apt_key:
            url: https://download.docker.com/linux/debian/gpg
            keyring: /etc/apt/keyrings/docker.gpg
            state: present

        - name: Add Docker repository
          apt_repository:
            repo: "deb [arch={{ ansible_architecture }} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
            state: present
            filename: docker

        - name: Install Docker packages
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            update_cache: true
      when: docker_check.rc != 0

    - name: Add user to docker group
      user:
        name: "{{ item }}"
        groups: docker
        append: true
      loop: "{{ docker_users }}"

    - name: Ensure UFW rules
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - 22
        - 80
        - 443

    - name: Enable UFW
      community.general.ufw:
        state: enabled
        policy: deny

    - name: Configure Fail2ban SSH jail
      copy:
        content: |
          [sshd]
          enabled = true
          port = ssh
          logpath = /var/log/auth.log
          maxretry = 5
          bantime = 3600
        dest: /etc/fail2ban/jail.d/sshd.local
        mode: '0644'

    - name: Ensure Fail2ban is running
      systemd:
        name: fail2ban
        state: started
        enabled: true

